<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brkthru RFP Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-orange-50 via-white to-slate-50 min-h-screen">
    <div id="app" class="max-w-6xl mx-auto p-8">
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-4"></div>
            <p class="text-slate-600">Loading Brkthru RFP Analyzer...</p>
        </div>
    </div>

    <script>
        const CONFIG = {
            google: {
                clientId: '1084111592719-99dj0bctr8vhrjuensgkdr0s70t0kptg.apps.googleusercontent.com',
                redirectUri: 'https://fosternf1-maker.github.io/brkthru-rfp-analyzer/',
                scope: 'https://www.googleapis.com/auth/presentations https://www.googleapis.com/auth/drive.file',
                templateId: '1G3YGavHm6fJdCMaLnlRllOlQvisC9Blo'
            },
            brkthru: {
                capabilities: {
                    programmatic: "Custom built for scale in the mid market with tech-agnostic approach.",
                    ctv: "Premium CTV across Disney+, Hulu, Paramount, Max, Netflix via programmatic.",
                    video: "Pre-roll, mid-roll, post-roll, YouTube TrueView, native video.",
                    display: "Standard, rich media, high impact, native, social mirroring.",
                    audio: "Streaming audio via Spotify, Pandora, AudioGo, podcasts.",
                    social: "Meta (Facebook/Instagram), TikTok, LinkedIn, Pinterest, Snapchat, X.",
                    sem: "Google Ads, Bing, Performance Max, YouTube advertising.",
                    dooh: "Digital out-of-home: billboards, transit, urban panels.",
                    geofencing: "Custom geofences, event targeting, customer loyalty.",
                    targeting: "Behavioral, contextual, CRM, lookalike, site retargeting."
                },
                differentiators: [
                    "No minimum spend requirements",
                    "White-glove service with 90% client satisfaction",
                    "Most sophisticated premium solution in mid-market",
                    "Tech-agnostic platform approach",
                    "235+ agency clients, 1,034 active brands"
                ],
                approach: {
                    awareness: "CTV/OTT, DOOH, Audio, YouTube, Display, Native, Social",
                    consideration: "Display, YouTube, Native, Social, SEM",
                    conversion: "Retargeting Display, Social, SEM"
                }
            }
        };

        let state = {
            accessToken: null,
            file: null,
            status: 'idle',
            progress: '',
            generatedContent: null,
            slidesDeckUrl: null
        };

        window.addEventListener('DOMContentLoaded', () => {
            const stored = localStorage.getItem('brkthru_google_token');
            if (stored) {
                const tokenData = JSON.parse(stored);
                if (tokenData.expiry > Date.now()) {
                    state.accessToken = tokenData.token;
                } else {
                    localStorage.removeItem('brkthru_google_token');
                }
            }

            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            if (code) {
                exchangeCodeForToken(code);
            } else {
                render();
            }
        });

        function authenticateGoogle() {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${CONFIG.google.clientId}&` +
                `redirect_uri=${encodeURIComponent(CONFIG.google.redirectUri)}&` +
                `response_type=code&` +
                `scope=${encodeURIComponent(CONFIG.google.scope)}&` +
                `access_type=offline&` +
                `prompt=consent`;
            window.location.href = authUrl;
        }

        async function exchangeCodeForToken(code) {
            updateProgress('Authenticating with Google...', 'processing');
            
            try {
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        code,
                        client_id: CONFIG.google.clientId,
                        client_secret: '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',
                        redirect_uri: CONFIG.google.redirectUri,
                        grant_type: 'authorization_code'
                    })
                });

                const data = await response.json();
                
                if (data.access_token) {
                    const tokenData = {
                        token: data.access_token,
                        expiry: Date.now() + (data.expires_in * 1000)
                    };
                    localStorage.setItem('brkthru_google_token', JSON.stringify(tokenData));
                    state.accessToken = data.access_token;
                    updateProgress('‚úÖ Successfully authenticated!', 'complete');
                    
                    window.history.replaceState({}, document.title, window.location.pathname);
                    setTimeout(render, 1000);
                }
            } catch (error) {
                updateProgress(`Authentication error: ${error.message}`, 'error');
            }
        }

        function disconnect() {
            localStorage.removeItem('brkthru_google_token');
            state.accessToken = null;
            render();
        }

        function handleFileUpload(event) {
            state.file = event.target.files[0];
            state.status = 'ready';
            render();
        }

        async function analyzeRFP() {
            if (!state.file || !state.accessToken) {
                alert('Please connect to Google and upload a file first!');
                return;
            }

            updateProgress('Reading RFP document...', 'processing');

            try {
                const fileContent = await readFile(state.file);
                
                updateProgress('Analyzing RFP with Claude AI...', 'processing');
                const analysis = await callClaudeAPI(fileContent);
                
                state.generatedContent = analysis;
                render();
                
                updateProgress('Creating Google Slides presentation...', 'processing');
                const deckUrl = await createGoogleSlides(analysis);
                
                state.slidesDeckUrl = deckUrl;
                updateProgress('‚úÖ Complete! Your presentation is ready.', 'complete');
                render();
                
            } catch (error) {
                updateProgress(`Error: ${error.message}`, 'error');
            }
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        async function callClaudeAPI(rfpContent) {
            const systemPrompt = `You are a digital media strategist for Brkthru, a mid-market digital advertising agency.

COMPANY PROFILE:
${JSON.stringify(CONFIG.brkthru, null, 2)}

Generate three strategic slides analyzing this RFP:

1. STRATEGY SLIDE - Extract client goals, recommend 3-5 media channels, explain why each channel supports their goals, include targeting approach.

2. INVESTMENT SLIDE - Propose media allocation percentages, break down by channel with budget, justify investment strategy, include expected KPIs.

3. RESEARCH SLIDE - Provide 3-5 industry insights relevant to their vertical, include supporting data and trends, cite sources.

Match funnel stage to tactics:
- Awareness ‚Üí CTV, Video, Display, Audio, Social
- Consideration ‚Üí Display, Native, YouTube, Social, SEM  
- Conversion ‚Üí Retargeting, SEM, targeted Social

OUTPUT AS JSON:
{
  "clientName": "extracted name",
  "strategy": {
    "goals": ["goal1", "goal2"],
    "targetAudience": "description",
    "geographicTarget": "location",
    "recommendedChannels": ["channel1", "channel2"],
    "narrative": "2-3 paragraph strategic explanation",
    "targetingApproach": "targeting details"
  },
  "investment": {
    "totalBudget": "amount",
    "flightDates": "dates",
    "mediaAllocation": [
      {"channel": "CTV/OTT", "percentage": 30, "budget": "$X", "rationale": "why", "kpis": "metrics"}
    ],
    "pixelStrategy": "conversion tracking recommendation"
  },
  "research": {
    "insights": [
      {"title": "headline", "finding": "detailed finding with data", "source": "source", "relevance": "how this applies"}
    ]
  }
}`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'anthropic-version': '2023-06-01'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 4096,
                    system: systemPrompt,
                    messages: [{
                        role: 'user',
                        content: `Analyze this RFP:\n\n${rfpContent}`
                    }]
                })
            });

            if (!response.ok) throw new Error(`Claude API Error: ${response.status}`);

            const data = await response.json();
            const content = data.content[0].text;
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            
            if (!jsonMatch) throw new Error('Failed to parse response');
            return JSON.parse(jsonMatch[0]);
        }

        async function createGoogleSlides(content) {
            updateProgress('Copying presentation template...', 'processing');
            
            const copyResponse = await fetch(
                `https://www.googleapis.com/drive/v3/files/${CONFIG.google.templateId}/copy`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: `${content.clientName || 'Client'} - RFP Proposal - ${new Date().toLocaleDateString()}`
                    })
                }
            );

            const newDeck = await copyResponse.json();
            if (!newDeck.id) throw new Error('Failed to copy template');
            
            const newDeckId = newDeck.id;

            updateProgress('Inserting new slides...', 'processing');
            
            const createRequests = [
                { createSlide: { insertionIndex: 5, slideLayoutReference: { predefinedLayout: 'TITLE_AND_BODY' }}},
                { createSlide: { insertionIndex: 6, slideLayoutReference: { predefinedLayout: 'TITLE_AND_BODY' }}},
                { createSlide: { insertionIndex: 7, slideLayoutReference: { predefinedLayout: 'TITLE_AND_BODY' }}}
            ];

            await fetch(`https://slides.googleapis.com/v1/presentations/${newDeckId}:batchUpdate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ requests: createRequests })
            });

            updateProgress('Adding content...', 'processing');

            const updatedRes = await fetch(
                `https://slides.googleapis.com/v1/presentations/${newDeckId}`,
                { headers: { 'Authorization': `Bearer ${state.accessToken}` }}
            );
            const updated = await updatedRes.json();
            const slideIds = updated.slides.slice(5, 8).map(s => s.objectId);

            const textRequests = [];
            
            for (let i = 0; i < 3; i++) {
                const slide = updated.slides.find(s => s.objectId === slideIds[i]);
                const textBoxes = slide.pageElements.filter(el => el.shape && el.shape.shapeType === 'TEXT_BOX');
                
                if (textBoxes.length >= 2) {
                    const titleBox = textBoxes[0];
                    const bodyBox = textBoxes[1];
                    
                    let titleText = '';
                    let bodyText = '';
                    
                    if (i === 0) {
                        titleText = 'üìä Behind the Strategy';
                        bodyText = `Goals: ${content.strategy.goals.join(', ')}\n\nTarget: ${content.strategy.targetAudience}\n\nChannels: ${content.strategy.recommendedChannels.join(', ')}\n\n${content.strategy.narrative}\n\nTargeting: ${content.strategy.targetingApproach}`;
                    } else if (i === 1) {
                        titleText = 'üí∞ Recommended Investment';
                        bodyText = `Budget: ${content.investment.totalBudget} | ${content.investment.flightDates}\n\n` +
                            content.investment.mediaAllocation.map(ch => 
                                `${ch.channel} - ${ch.percentage}% (${ch.budget})\n${ch.rationale}\nKPIs: ${ch.kpis}`
                            ).join('\n\n') +
                            `\n\n${content.investment.pixelStrategy}`;
                    } else {
                        titleText = 'üîç Market Research & Insights';
                        bodyText = content.research.insights.map(ins => 
                            `${ins.title}\n${ins.finding}\nSource: ${ins.source}`
                        ).join('\n\n');
                    }
                    
                    textRequests.push(
                        { insertText: { objectId: titleBox.objectId, text: titleText, insertionIndex: 0 }},
                        { insertText: { objectId: bodyBox.objectId, text: bodyText, insertionIndex: 0 }}
                    );
                }
            }

            await fetch(`https://slides.googleapis.com/v1/presentations/${newDeckId}:batchUpdate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${state.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ requests: textRequests })
            });

            return `https://docs.google.com/presentation/d/${newDeckId}/edit`;
        }

        function updateProgress(message, status) {
            state.progress = message;
            state.status = status;
            render();
        }

        function render() {
            const app = document.getElementById('app');
            const isAuth = !!state.accessToken;

            app.innerHTML = `
                <div class="text-center mb-8">
                    <div class="inline-flex items-center gap-3 mb-4">
                        <svg class="w-12 h-12 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <h1 class="text-5xl font-bold text-slate-900">Brkthru RFP Analyzer</h1>
                    </div>
                    <p class="text-slate-600 text-xl">Upload RFP ‚Üí AI Strategy ‚Üí Auto-Generated Slides</p>
                </div>

                <div class="mb-6">
                    ${isAuth ? `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center justify-between">
                            <span class="text-green-800 font-medium">‚úì Connected to Google Slides</span>
                            <button onclick="disconnect()" class="text-sm text-green-700 hover:text-green-900 underline">Disconnect</button>
                        </div>
                    ` : `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="font-semibold text-blue-900 mb-2">Connect to Google Slides</h3>
                            <p class="text-blue-800 mb-4">Authorize access to create presentations.</p>
                            <button onclick="authenticateGoogle()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                Connect Google Account
                            </button>
                        </div>
                    `}
                </div>

                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <label class="block cursor-pointer mb-8">
                        <div class="border-2 border-dashed border-slate-300 rounded-xl p-12 text-center hover:border-orange-400 transition">
                            <input type="file" onchange="handleFileUpload(event)" accept=".pdf,.doc,.docx,.txt" class="hidden"/>
                            <svg class="w-12 h-12 mx-auto mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-lg font-medium text-slate-700">${state.file ? state.file.name : 'Drop RFP or click to upload'}</p>
                            <p class="text-sm text-slate-500">PDF, Word, or Text</p>
                        </div>
                    </label>

                    ${state.file ? `
                        <button onclick="analyzeRFP()" ${state.status === 'processing' || !isAuth ? 'disabled' : ''}
                            class="w-full mb-8 px-6 py-4 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 disabled:opacity-50 text-lg">
                            ${state.status === 'processing' ? '‚è≥ Processing...' : '‚ö° Generate Slides'}
                        </button>
                    ` : ''}

                    ${state.progress ? `
                        <div class="p-4 rounded-lg mb-6 ${
                            state.status === 'error' ? 'bg-red-50 text-red-700' :
                            state.status === 'complete' ? 'bg-green-50 text-green-700' :
                            'bg-blue-50 text-blue-700'
                        }">
                            <span class="font-medium">${state.progress}</span>
                        </div>
                    ` : ''}

                    ${state.generatedContent ? `
                        <div class="space-y-4 mb-6">
                            <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-r">
                                <strong>üìä Strategy:</strong> ${state.generatedContent.strategy.recommendedChannels.join(', ')}
                            </div>
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
                                <strong>üí∞ Investment:</strong> ${state.generatedContent.investment.totalBudget}
                            </div>
                            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r">
                                <strong>üîç Research:</strong> ${state.generatedContent.research.insights.length} insights generated
                            </div>
                        </div>
                    ` : ''}

                    ${state.slidesDeckUrl ? `
                        <a href="${state.slidesDeckUrl}" target="_blank" 
                            class="block w-full py-4 bg-green-600 text-white rounded-xl font-bold text-center text-lg hover:bg-green-700">
                            Open Presentation in Google Slides ‚Üí
                        </a>
                    ` : ''}
                </div>

                <div class="mt-8 text-center text-sm text-slate-500">
                    <p>üîí Secure ‚Ä¢ Powered by Claude AI + Google Slides API</p>
                </div>
            `;
        }
    </script>
</body>
</html>
